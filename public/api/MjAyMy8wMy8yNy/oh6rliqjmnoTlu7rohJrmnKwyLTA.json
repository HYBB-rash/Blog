{"title":"自动构建脚本2.0","date":"2023-03-27T03:08:19.000Z","date_formatted":{"ll":"Mar 27, 2023","L":"03/27/2023","MM-DD":"03-27"},"link":"2023/03/27/自动构建脚本2-0","tags":["bash","chatgpt","博客网站"],"updated":"2023-04-08T19:43:26.900Z","content":"<p>自动构建脚本更新了一版, 做到无感更新. 主要是通过检测 GitHub 的最新版本是否和现在的版本一致, 如果不一致则立刻发起更新和构建.</p>\n<p>新脚本如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">ROOT=<span class=\"string\">&quot;项目的位置&quot;</span></span><br><span class=\"line\">LOG_FILE=<span class=\"string\">&quot;<span class=\"variable\">$ROOT</span>/logs/update.log&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将当前时间戳写入日志文件</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] Checking for updates...&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$ROOT</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">remote_hash=$(git ls-remote 「我的 GitHub url」 -h refs/heads/master | awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class=\"line\">local_hash=$(git rev-parse HEAD)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] Remote hash <span class=\"variable\">$remote_hash</span>. Local hash <span class=\"variable\">$local_hash</span>.&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$remote_hash</span>&quot;</span> != <span class=\"string\">&quot;<span class=\"variable\">$local_hash</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] Update found. Pulling changes and generating...&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 从 GitHub 拉取代码更新</span></span><br><span class=\"line\">    git pull github master &gt;&gt; <span class=\"variable\">$LOG_FILE</span> 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 执行 hexo generate</span></span><br><span class=\"line\">    hexo generate &gt;&gt; <span class=\"variable\">$LOG_FILE</span> 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] Update and generation completed.&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] No updates found.&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;[<span class=\"subst\">$(date)</span>] ..........................................................................................................&quot;</span> &gt;&gt; <span class=\"variable\">$LOG_FILE</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>然后在服务器上设置定时任务即可.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">*/5 * * * * /path/to/auto_update_with_log.sh</span><br></pre></td></tr></table></figure>\n","prev":{"title":"texgt","link":"2023/03/27/texgt"},"next":{"title":"自动构建脚本","link":"2023/03/27/自动构建脚本"},"plink":"https://man-her.tech/2023/03/27/自动构建脚本2-0/","reading_time":"230 words in 2 min"}